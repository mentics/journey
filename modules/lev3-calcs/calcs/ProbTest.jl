module ProbTest
using Test, TestUtil
using SH, Bins, CalcUtil
using ProbTypes, ProbUtil

function runTests()
    @testset "cdf" begin
        zeroProbs = Prob(50.0, Bins.with(0.0))
        for x in Bins.XS
            @test probsCdf(zeroProbs, x) === 0.0
        end

        randProbs = Prob(100.0, rand(Bins.VNUM))
        normalize!(randProbs.vals)
        @test sum(randProbs.vals) ≅ 1.0
        @test probsCdf(randProbs, 0.0) === valLeft(randProbs)
        @test within(probsCdf(randProbs, 1.0), 0.5, 0.05)
        @test probsCdf(randProbs, 1000.0) === 1.0
        prev = 0.0
        for x in binMin():binWidth():binMax()
            p = probsCdf(randProbs, x)
            @test p > prev
            prev = p
        end

        flatProbs = Prob(100.0, Bins.with(1.0))
        normalize!(flatProbs.vals)
        @test sum(flatProbs.vals) ≅ 1.0
        @test probsCdf(flatProbs, 0.0) === valLeft(flatProbs)
        @test probsCdf(flatProbs, 1.0) ≅ 0.5
        @test probsCdf(flatProbs, 1000.0) === 1.0
        prev = 0.0
        w = 1.0 / Bins.VNUM

        for (i, x) in xsi()
            @test (1.0 - probsCdf(flatProbs, x) / (i * w)) < 0.001
        end
    end

    @testset "norm dist" begin
        @warn "TODO: update this test"
        return
        p1 = probsNormDist(450.0, 0.02)
        @test p1.center === 450.0
        @test sum(getVals(p1)) ≅ 1.0
        # @test probsCdf.(Ref(p1), .95:(0.1/402.0):1.05)

        test = (getVals(p1) ./ binWidth())[2:(end-1)]
        expected = [0.8764150246784218, 0.904024922363417, 0.9323603742971925, 0.9614352183617237, 0.9912633765930746, 1.0218588490581169, 1.0532357074793006, 1.0854080886061082, 1.1183901873311752, 1.152196249550178, 1.1868405647639328, 1.2223374584222206, 1.2587012840085965, 1.2959464148656799, 1.3340872357612847, 1.3731381341950883, 1.4131134914469083, 1.4540276733668789, 1.4958950209090598, 1.5387298404097778, 1.582546393612242, 1.6273588874400162, 1.6731814635211717, 1.7200281874665233, 1.7679130379044092, 1.8168498952761627, 1.86685253039546, 1.9179345927762566, 1.9701095987336936, 2.023390919262684, 2.077791767700055, 2.1333251871752803, 2.190004037856611, 2.2478409839983557, 2.3068484807968184, 2.367038761061882, 2.428423821711678, 2.491015410099025, 2.5548250101772862, 2.6198638285153497, 2.686142780170114, 2.7536724744270087, 2.8224632004176664, 2.8925249126259414, 2.963867216292755, 3.0364993527306474, 3.110430184560391, 3.1856681808805987, 3.262221402383687, 3.340097486429779, 3.4193036320926495, 3.499846585190007, 3.5817326233126785, 3.6649675408663693, 3.749556634139976, 3.835504686416014, 3.9228159531369564, 4.0114941471439165, 4.101542424001984, 4.192963367428954, 4.2857589748430485, 4.379930643045472, 4.47547915405525, 4.572404661111742, 4.67070667486298, 4.770384049755476, 4.871434970644029, 4.973856939637438, 5.077646763198614, 5.182800539516154, 5.289313646164398, 5.397180728070818, 5.506395685806824, 5.616951664221223, 5.728841041432369, 5.8420554181981785, 5.956585607680017, 6.0724216256191355, 6.189552680942538, 6.307967166814955, 6.42765265215531, 6.54859587363293, 6.670782728161901, 6.794198265908377, 6.91882668382838, 7.0446513197515435, 7.171654647025824, 7.299818269739934, 7.4291229185367, 7.559548447033746, 7.691073828863871, 7.8236771553507225, 7.957335633831268, 8.092025586639394, 8.227722450762343, 8.364400778181244, 8.502034236908486, 8.640595612730761, 8.780056811669835, 8.920388863168583, 9.061561924013093, 9.203545282997151, 9.346307366338129, 9.48981574385051, 9.634037135882496, 9.778937421022645, 9.924481644579144,
    10.070634027837643, 10.217357978098649, 10.364616099498315, 10.512370204613465, 10.660581326850691, 10.809209733620916, 10.958214940296298, 11.107555724949503, 11.25719014387044, 11.407075547858732, 11.557168599285259, 11.707425289918808, 11.85780095951077, 12.008250315129736, 12.158727451239438, 12.309185870508674, 12.459578505345322, 12.609857740141184, 12.759975434217505, 12.909882945457527, 13.059531154611674, 13.208870490262376, 13.35785095443085, 13.506422148811565, 13.654533301614926, 13.802133295002122, 13.949170693091045, 14.0955937705151, 14.241350541513528, 14.386388789531171, 14.53065609730697, 14.674099877426228, 14.816667403314904, 14.9583058406494, 15.098962279158737, 15.238583764791233, 15.377117332220813, 15.514510037665191, 15.650708991987575, 15.78566139405516, 15.919314564323736, 16.051615978621008, 16.182513302096908, 16.311954423312642, 16.439887488435957, 16.566260935513167, 16.691023528785973, 16.81412439302089, 16.935513047820884, 17.05513944188529, 17.17295398718758, 17.288907593036736, 17.402951699991227, 17.51503831359224, 17.62512003788315, 17.733150108683894, 17.83908242658602, 17.942871589637647, 18.044472925684445, 18.143842524335643, 18.240937268522735, 18.33571486561867, 18.42813387808735, 18.51815375363096, 18.6057348548059, 18.69083848807575, 18.773426932272738, 18.853463466437255, 18.93091239700767, 19.00573908433181, 19.077909968472298, 19.147392594279687, 19.214155635706106, 19.278168919335027, 19.33940344710137, 19.397831418178974, 19.45342625001145, 19.506162598464815, 19.556016377080244, 19.60296477540622, 19.646986276391218, 19.688060672817528, 19.726169082759455, 19.761293964048622, 19.79341912773152, 19.82252975050423, 19.848612386111448, 19.87165497569732, 19.891646857096852, 19.908578773058093, 19.922442878385997, 19.933232746000463, 19.94094337190176, 19.945571179038183, 19.947114020071634, 19.945571179038183, 19.940943371901763, 19.933232746000467, 19.922442878386, 19.908578773058093, 19.891646857096852, 19.871654975697332, 19.84861238611146, 19.82252975050423, 19.79341912773152, 19.761293964048654, 19.726169082759466, 19.688060672817546, 19.646986276391218, 19.60296477540622, 19.55601637708026, 19.50616259846484, 19.45342625001145, 19.397831418178974, 19.339403447101425, 19.27816891933506, 19.214155635706135, 19.147392594279687, 19.077909968472298, 19.005739084331843, 18.930912397007702, 18.853463466437255, 18.773426932272738, 18.690838488075826, 18.605734854805938, 18.518153753630997, 18.42813387808735, 18.33571486561867, 18.240937268522778, 18.14384252433569, 18.044472925684445, 17.942871589637647, 17.83908242658602, 17.733150108683944, 17.625120037883203, 17.51503831359224, 17.402951699991227, 17.288907593036786, 17.17295398718763, 17.055139441885345, 16.935513047820884, 16.814124393020997, 16.691023528786026, 16.566260935513224, 16.439887488435957, 16.311954423312642, 16.182513302097025, 16.051615978621065, 15.919314564323795, 15.78566139405516, 15.650708991987575, 15.514510037665255, 15.377117332220873, 15.238583764791233, 15.098962279158737, 14.958305840649526, 14.816667403314964, 14.674099877426292, 14.53065609730697, 14.386388789531171, 14.241350541513592, 14.095593770515164, 13.949170693091045, 13.802133295002122, 13.654533301615057, 13.50642214881163, 13.357850954430916, 13.208870490262376, 13.059531154611674, 12.909882945457593, 12.759975434217571, 12.609857740141184, 12.459578505345322, 12.309185870508674, 12.158727451239503,
    12.008250315129805, 11.85780095951077, 11.707425289918808, 11.557168599285324, 11.407075547858799, 11.257190143870508, 11.107555724949503, 10.95821494029643, 10.809209733620985, 10.660581326850757, 10.512370204613465, 10.364616099498315, 10.217357978098713, 10.070634027837711, 9.92448164457921, 9.778937421022645, 9.634037135882496, 9.489815743850574, 9.346307366338191, 9.203545282997151, 9.061561924013093, 8.920388863168709, 8.780056811669898, 8.640595612730824, 8.502034236908486, 8.364400778181244, 8.227722450762402, 8.092025586639453, 7.957335633831268, 7.8236771553507225, 7.691073828863989, 7.559548447033805, 7.429122918536758, 7.299818269739934, 7.171654647025824, 7.0446513197516, 6.918826683828437, 6.794198265908377, 6.670782728161901, 6.5485958736330385, 6.427652652155364, 6.3079671668150095, 6.189552680942538, 6.0724216256191355, 5.9565856076800685, 5.842055418198229, 5.728841041432419, 5.616951664221223, 5.506395685806922, 5.3971807280708655, 5.289313646164446, 5.182800539516154, 5.077646763198614, 4.973856939637483, 4.871434970644074, 4.7703840497555206, 4.67070667486298, 4.572404661111742, 4.475479154055293, 4.3799306430455145, 4.2857589748430485, 4.192963367428954, 4.101542424002025, 4.011494147143956, 3.922815953136997, 3.835504686416014, 3.749556634139976, 3.664967540866406, 3.5817326233127145, 3.499846585190007, 3.4193036320926495, 3.34009748642985, 3.262221402383722, 3.1856681808806324, 3.110430184560391, 3.0364993527306474, 2.9638672162927873, 2.8925249126259733, 2.8224632004176664, 2.7536724744270087, 2.6861427801701736, 2.6198638285153777, 2.5548250101773133, 2.491015410099025, 2.428423821711678, 2.367038761061908, 2.3068484807968437, 2.2478409839983557, 2.190004037856611, 2.1333251871753305, 2.077791767700079, 2.023390919262707, 1.9701095987336936, 1.9179345927762566, 1.8668525303954817, 1.816849895276184, 1.7679130379044303, 1.7200281874665233, 1.6731814635211717, 1.6273588874400349, 1.582546393612261, 1.5387298404097778, 1.4958950209090598, 1.4540276733668964, 1.4131134914469254, 1.3731381341951054, 1.3340872357612847, 1.2959464148657134, 1.258701284008612, 1.2223374584222364, 1.1868405647639328, 1.152196249550178, 1.118390187331205, 1.085408088606122, 1.0532357074793142, 1.0218588490581169, 0.9912633765930746, 0.9614352183617362, 0.932360374297205, 0.904024922363417, 0.8764150246784218]

    # TODO: expected needs updated for bins change

        i = 0
        for (x1,x2) in zip(test, expected)
            i += 1
            if !(within(x1, x2, .1))
                @error "test" i x1 x2 (1.0 - x1/x2)
                break
            end
        end
    end
end

end